"use strict";module.exports=function(t){var n,e=window,s={hash:"",type:"!"},i=encodeURIComponent,u=decodeURIComponent,r=[],h={},a={},o={},c={"!":"/","?":"="},f={"!":"/","?":"&"},l=/^[^#]*/,_=/^(#[^#]*)(#?.*)$/,p=t.isArray,y=t.inArray,v=t.each;function d(t){this.options=t}t.hash=function(n){"string"===t.type(n)&&(n={hash:n});var i=t.extend({},s,n);return i.hash=i.hash||e.location.hash,new d(i)._parse()},t.hash.defaults=s,t(e).bind("hashchange",function(e){var s=e.originalEvent,i=t.hash(s.newURL).get(),u=t.hash(s.oldURL).get(),c={},f=[],l=[],_=[],p=[];v(i,function(t,e){u[t]!==e&&c[t]===n&&(c[t]={old:u[t],new:e},f.push(t))}),v(u,function(t,e){i[t]!==e&&c[t]===n&&(c[t]={old:e,new:i[t]},f.push(t))}),f.length&&(v(f,function(t,n){var e,s;h[n]&&v(h[n].callbacks,function(t,n){~y(n,l)||l.push(n)}),a[n]&&v(a[n].callbacks,function(t,n){~y(n,_)||_.push(n)}),o[n]&&(e=o[n].keys,v(e,function(t,n){if(!~y(n,f))return s=!0,!1}),s||v(o[n].callbacks,function(t,n){~y(n,p)||p.push(n)}))}),v(l,function(t,n){n(i,u)}),v(_,function(t,n){n(i,u)}),v(p,function(t,n){n(i,u)}),v(r,function(t,n){n(i,u)}))}),d.prototype={_reset:function(){this._equal=c[this._type],this._split=f[this._type]},_parse:function(){var t,n,e,s=this,i=s.options,r=i.hash,h={};return"!"!==(r=r.replace(l,""))[1]&&"?"!==r[1]?(s._type=i.type,s._reset(),s._suffix="",s._result={},s):(t=r.match(_),s._hash=t[1],s._suffix=t[2],s._type=s._hash[1],s._reset(),s._result=h,s._hash=s._hash.replace(/^[#!?\/]+/,""),n=s._hash.split(s._split),"!"===s._type?v(n,function(t,n){t%2?e&&(h[e]=u(n)):(e=n,n&&(h[n]=""))}):"?"===s._type&&v(n,function(t,n){var e=n.indexOf(s._equal),i=n.slice(0,e),r=u(n.slice(e+1));i&&(h[i]=r||"")}),s._result=h,s)},stringify:function(t){var n=this,e=[];return"!"!==t&&"?"!==t||(n._type=t,n._reset()),v(n._result,function(t,s){e.push(t+n._equal+i(s))}),n._hash=n._type+e.join(n._split),"#"+n._hash+n._suffix},location:function(t){function n(n){return t.apply(this,arguments)}return n.toString=function(){return t.toString()},n}(function(t){location.hash=this.stringify(t).replace(/^#+/,"")}),set:function(e,s){var i={};return s===n?i=e:i[e]=s,t.extend(this._result,i),this},get:function(t){if(t===n)return this._result;var e=p(t),s={},i=this;return v(e?t:[t],function(t,n){s[n]=i._result[n]}),e?s:s[t]},remove:function(t){var e=this;if(t===n)return e._result={},e;var s=p(t);return v(s?t:[t],function(t,n){delete e._result[n]}),e},listen:function(){var t,e=arguments,s=e.length,i=e[0],u=e[s-1],c=2===s&&p(i),f=s>2,l=1===s,_=[];return l?t=r:!c&&!f&&!l?(_=[i],t=h):f?(_=[].slice.call(e,0,s-1),t=a):(_=i,t=o),l?~y(u,t)||t.push(u):v(_,function(e,s){t[s]===n&&(t[s]={}),_.length>1&&t[s].keys===n&&(t[s].keys=[]),t[s].callbacks==n&&(t[s].callbacks=[]);var i=t[s].keys,r=t[s].callbacks;t[s].keys&&v(_,function(t,n){~y(n,i)||n===s||i.push(n)}),~y(u,r)||r.push(u)}),this},suffix:function(t){return t===n?this._suffix:(this._suffix="#"+t,this)}}};